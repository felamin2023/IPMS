// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
}

// ── Enums ───────────────────────────────────────────

enum UserRole {
  admin
  department_user
}

enum RequestStatus {
  submitted
  received
  under_review
  approved
  rejected
  completed
}

// ── Colleges / Programs ─────────────────────────────

model College {
  id        String   @id @default(uuid())
  code      String   @unique // CAFE, CAS, COE, CHMT, COTE
  name      String
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz

  programs Program[]
  users    User[]
  requests Request[]

  @@map("colleges")
}

model Program {
  id        String   @id @default(uuid())
  collegeId String   @map("college_id")
  code      String
  name      String
  isActive  Boolean  @default(true) @map("is_active")
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz

  college  College   @relation(fields: [collegeId], references: [id], onDelete: Cascade)
  users    User[]
  requests Request[]

  @@unique([collegeId, code])
  @@map("programs")
}

// ── Users ───────────────────────────────────────────

model User {
  id           String   @id @default(uuid())
  firstName    String   @map("first_name")
  lastName     String   @map("last_name")
  email        String?  @unique
  passwordHash String   @map("password_hash")
  role         UserRole
  collegeId    String?  @map("college_id")  // NULL for admin
  programId    String?  @map("program_id")  // NULL for admin
  createdAt    DateTime @default(now()) @map("created_at") @db.Timestamptz

  college  College? @relation(fields: [collegeId], references: [id])
  program  Program? @relation(fields: [programId], references: [id])

  createdRequests  Request[]          @relation("RequestCreator")
  statusLogEntries RequestStatusLog[] @relation("StatusLogUpdater")

  @@map("users")
}

// ── Requests ────────────────────────────────────────

model Request {
  id         String        @id @default(uuid())
  prNo       String?       @unique @map("pr_no")
  collegeId  String        @map("college_id")
  programId  String        @map("program_id")
  purpose    String?
  fundSource String?       @map("fund_source")
  status     RequestStatus @default(submitted)
  createdBy  String        @map("created_by")
  createdAt  DateTime      @default(now()) @map("created_at") @db.Timestamptz
  updatedAt  DateTime      @updatedAt @map("updated_at") @db.Timestamptz

  college College @relation(fields: [collegeId], references: [id])
  program Program @relation(fields: [programId], references: [id])
  creator User    @relation("RequestCreator", fields: [createdBy], references: [id])

  items      RequestItem[]
  statusLogs RequestStatusLog[]

  @@map("requests")
}

// ── Request Items ───────────────────────────────────

model RequestItem {
  id              String   @id @default(uuid())
  requestId       String   @map("request_id")
  stockNo         String?  @map("stock_no")
  qty             Int
  itemDescription String   @map("item_description")
  uom             String   // pcs, box, ream, etc.
  unitCost        Decimal? @map("unit_cost") @db.Decimal(12, 2)
  totalCost       Decimal? @map("total_cost") @db.Decimal(12, 2)

  request Request @relation(fields: [requestId], references: [id], onDelete: Cascade)

  @@map("request_items")
}

// ── Request Status Logs (Timeline / Tracking) ───────

model RequestStatusLog {
  id        String   @id @default(uuid())
  requestId String   @map("request_id")
  status    String   // same values as RequestStatus
  note      String?  // e.g., "Forwarded to admin for receiving"
  updatedBy String   @map("updated_by")
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz

  request Request @relation(fields: [requestId], references: [id], onDelete: Cascade)
  updater User    @relation("StatusLogUpdater", fields: [updatedBy], references: [id])

  @@map("request_status_logs")
}
